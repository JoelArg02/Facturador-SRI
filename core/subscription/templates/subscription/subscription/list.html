{% extends 'list.html' %}
{% load static %}

{% block columns %}
<tr>
    <th>Administrador</th>
    <th>Compañía</th>
    <th>Plan</th>
    <th>Facturas</th>
    <th>Clientes</th>
    <th>Productos</th>
    <th>Inicio</th>
    <th>Fin</th>
    <th>Activa</th>
    <th>Expirada</th>
    <th>Días restantes</th>
    <th class="text-center">Opciones</th>
</tr>
{% endblock %}

{% block rows %}
<tr><td colspan="12" class="text-center">Cargando información...</td></tr>
{% endblock %}

{% block javascript_list %}
<script>
    function renderUsage(metric){
        if(metric.limit === null || metric.limit === 0){
            return `<span class="badge badge-info">${metric.used} / ∞</span>`;
        }
        const percent = Math.min(metric.percent ?? 0, 100);
        return `
            <div class="mb-1"><strong>${metric.display}</strong></div>
            <div class="progress" style="height:6px;">
                <div class="progress-bar" role="progressbar" style="width:${percent}%" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>`;
    }

    function loadSubs(){
        $.ajax({
            url: window.location.pathname,
            method: 'POST',
            data: {action: 'search', csrfmiddlewaretoken: '{{ csrf_token }}'},
            dataType: 'json',
            success: function(resp){
                const tbody = $('table tbody');
                tbody.empty();

                if (!Array.isArray(resp)) {
                    console.error('La respuesta no es un array:', resp);
                    tbody.append('<tr><td colspan="12" class="text-center">Error: respuesta inválida</td></tr>');
                    return;
                }

                if(resp.length === 0){
                    tbody.append('<tr><td colspan="12" class="text-center">Sin resultados</td></tr>');
                } else {
                    resp.forEach(o => {
                        const invoiceUsage = renderUsage(o.usage.invoice);
                        const customerUsage = renderUsage(o.usage.customer);
                        const productUsage = renderUsage(o.usage.product);
                        const companyName = o.company.name || '<span class="badge badge-warning">Sin compañía</span>';
                        const companyInfo = o.company.id ? `${companyName}<br><small class="text-muted">RUC: ${o.company.ruc}</small>` : companyName;
                        $('table tbody').append(`
                        <tr>
                            <td>
                                ${o.owner.name}<br>
                                <small class="text-muted">@${o.owner.username}</small><br>
                                <small class="badge badge-primary">${o.owner.groups}</small>
                            </td>
                            <td>${companyInfo}</td>
                            <td>${o.plan.name}</td>
                            <td>${invoiceUsage}</td>
                            <td>${customerUsage}</td>
                            <td>${productUsage}</td>
                            <td>${o.start_date}</td>
                            <td>${o.end_date || ''}</td>
                            <td>${o.is_active ? '<span class="badge badge-success">Sí</span>' : '<span class="badge badge-danger">No</span>'}</td>
                            <td>${o.expired ? '<span class="badge badge-danger">Sí</span>' : '<span class="badge badge-success">No</span>'}</td>
                            <td>${o.days_left ?? ''}</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-xs btn-update" data-id="${o.id}" title="Actualizar suscripción"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-xs btn-delete" data-id="${o.id}" title="Eliminar suscripción"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`);
                    });
                }
            }
        });
    }

    function openUpdateModal(subscriptionId) {
        const $modal = $('#updateSubscriptionModal');

        if ($modal.length === 0) {
            console.error('Modal no encontrado en el DOM');
            alert('Error: Modal no encontrado');
            return;
        }

        $.ajax({
            url: `/subscription/update/${subscriptionId}/`,
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            dataType: 'json',
            success: function(resp) {
                if(resp.error) { alert(resp.error); return; }

                const subscription = resp.subscription;
                const plans = resp.available_plans || [];
                const planName = (subscription.plan && subscription.plan.name) ? subscription.plan.name : 'Plan desconocido';
                const isActive = !!subscription.is_active;
                const daysLeft = subscription.days_left ?? 'N/A';

                $modal.find('.current-subscription-info').html(`
                    <strong>Suscripción actual:</strong><br>
                    <span class="badge badge-info">${planName}</span><br>
                    <small class="text-muted">
                        Estado: ${isActive ? '<span class="text-success">Activa</span>' : '<span class="text-danger">Inactiva</span>'}<br>
                        Días restantes: ${daysLeft}
                    </small>
                `);

                const $planSelect = $modal.find('#new_plan_id');
                $planSelect.empty().append('<option value="">Seleccionar nuevo plan...</option>');
                plans.forEach(p => {
                    if (p.id && (!subscription.plan || p.id !== subscription.plan.id)) {
                        $planSelect.append(`<option value="${p.id}">${p.name} - $${(p.price ?? 0)}/${(p.period_days ?? 0)} días</option>`);
                    }
                });

                $modal.find('.btn-change-plan').data('id', subscriptionId);
                $modal.find('.btn-suspend').data('id', subscriptionId);
                $modal.find('.btn-reactivate').data('id', subscriptionId);
                $modal.find('.btn-extend').data('id', subscriptionId);

                // Configurar fecha mínima (hoy)
                const today = new Date().toISOString().split('T')[0];
                $modal.find('#extend_date').attr('min', today);
                
                // Si hay fecha de fin, usarla como valor por defecto
                if(subscription.end_date) {
                    $modal.find('#extend_date').val(subscription.end_date);
                }

                if(isActive) {
                    $modal.find('.btn-suspend').show();
                    $modal.find('.btn-reactivate').hide();
                } else {
                    $modal.find('.btn-suspend').hide();
                    $modal.find('.btn-reactivate').show();
                }

                $modal.modal('show');
            },
            error: function(xhr, status, error) {
                console.error('Error en AJAX:', {xhr, status, error});
                alert('Error al cargar datos de la suscripción: ' + error);
            }
        });
    }

    function updateSubscription(subscriptionId, action, data = {}) {
        const postData = Object.assign({
            action: action,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, data);

        $.ajax({
            url: `/subscription/update/${subscriptionId}/`,
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            data: postData,
            dataType: 'json',
            success: function(resp) {
                if(resp.error){
                    alert(resp.error);
                } else {
                    alert(resp.success);
                    $('#updateSubscriptionModal').modal('hide');
                    loadSubs();
                }
            },
            error: function() {
                alert('Error al actualizar la suscripción');
            }
        });
    }

    $(function(){
        loadSubs();

        $('table').on('click', '.btn-delete', function(){
            if(!confirm('¿Eliminar suscripción?')) return;
            const id = $(this).data('id');
            $.ajax({
                url: window.location.pathname,
                method: 'POST',
                data: {action: 'delete', id: id, csrfmiddlewaretoken: '{{ csrf_token }}'},
                dataType: 'json',
                success: function(resp){
                    if(resp.error){ alert(resp.error); }
                    else { loadSubs(); }
                }
            });
        });

        $('table').on('click', '.btn-update', function(){
            const id = $(this).data('id');
            openUpdateModal(id);
        });

        $('#updateSubscriptionModal').on('click', '.btn-change-plan', function() {
            const subscriptionId = $(this).data('id');
            const newPlanId = $('#new_plan_id').val();
            if(!newPlanId) { alert('Por favor selecciona un nuevo plan'); return; }
            if(confirm('¿Estás seguro de cambiar el plan de esta suscripción?')) {
                updateSubscription(subscriptionId, 'change_plan', { new_plan_id: newPlanId });
            }
        });

        $('#updateSubscriptionModal').on('click', '.btn-suspend', function() {
            const subscriptionId = $(this).data('id');
            if(confirm('¿Estás seguro de suspender esta suscripción?')) {
                updateSubscription(subscriptionId, 'suspend');
            }
        });

        $('#updateSubscriptionModal').on('click', '.btn-reactivate', function() {
            const subscriptionId = $(this).data('id');
            if(confirm('¿Estás seguro de reactivar esta suscripción?')) {
                updateSubscription(subscriptionId, 'reactivate');
            }
        });

        $('#updateSubscriptionModal').on('click', '.btn-extend', function() {
            const subscriptionId = $(this).data('id');
            const extendDate = $('#extend_date').val();
            if(!extendDate) { alert('Por favor selecciona una fecha'); return; }
            if(confirm(`¿Estás seguro de extender la suscripción hasta ${extendDate}?`)) {
                updateSubscription(subscriptionId, 'extend', { extend_date: extendDate });
            }
        });
    });
</script>

<!-- Modal de actualización de suscripción (debe existir en el DOM antes de llamar .modal('show')) -->
<div class="modal fade" id="updateSubscriptionModal" tabindex="-1" role="dialog" aria-labelledby="updateSubscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateSubscriptionModalLabel">Actualizar Suscripción</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Información Actual</h6>
                            </div>
                            <div class="card-body">
                                <div class="current-subscription-info"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Cambiar Plan</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="new_plan_id">Nuevo Plan:</label>
                                    <select class="form-control" id="new_plan_id">
                                        <option value="">Seleccionar nuevo plan...</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary btn-change-plan btn-block">Cambiar Plan</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Extender Suscripción</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="extend_date">Nueva Fecha de Fin:</label>
                                    <input type="date" class="form-control" id="extend_date" min="">
                                </div>
                                <button type="button" class="btn btn-info btn-extend btn-block">Extender Suscripción</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Acciones de Suscripción</h6>
                            </div>
                            <div class="card-body">
                                <div class="btn-group w-100">
                                    <button type="button" class="btn btn-warning btn-suspend">Suspender Suscripción</button>
                                    <button type="button" class="btn btn-success btn-reactivate" style="display: none;">Reactivar Suscripción</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
