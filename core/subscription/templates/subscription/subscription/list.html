{% extends 'list.html' %}
{% load stati            success: function(resp){
                console.log('Respuesta del servidor:', resp);
                const tbody = $('table tbody');
                tbody.empty();
                
                // Verificar si resp es un array
                if (!Array.isArray(resp)) {
                    console.error('La respuesta no es un array:', resp);
                    tbody.append('<tr><td colspan="12" class="text-center">Error: respuesta inválida</td></tr>');
                    return;
                }
                
                if(resp.length === 0){
                    tbody.append('<tr><td colspan="12" class="text-center">Sin resultados</td></tr>');
                } else {
                    resp.forEach(o => {% block columns %}
<tr>
    <th>Administrador</th>
    <th>Compañía</th>
    <th>Plan</th>
    <th>Facturas</th>
    <th>Clientes</th>
    <th>Productos</th>
    <th>Inicio</th>
    <th>Fin</th>
    <th>Activa</th>
    <th>Expirada</th>
    <th>Días restantes</th>
    <th class="text-center">Opciones</th>
</tr>
{% endblock %}
{% block rows %}
    <tr><td colspan="12" class="text-center">Cargando información...</td></tr>
{% endblock %}
{% block javascript_list %}
<script>
    function renderUsage(metric){
        if(metric.limit === null || metric.limit === 0){
            return `<span class="badge badge-info">${metric.used} / ∞</span>`;
        }
        const percent = Math.min(metric.percent ?? 0, 100);
        return `
            <div class="mb-1"><strong>${metric.display}</strong></div>
            <div class="progress" style="height:6px;">
                <div class="progress-bar" role="progressbar" style="width:${percent}%" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>`;
    }

    function loadSubs(){
        $.ajax({
            url: window.location.pathname,
            method: 'POST',
            data: {action: 'search', csrfmiddlewaretoken: '{{ csrf_token }}'},
            success: function(resp){
                const tbody = $('table tbody');
                tbody.empty();
                if(resp.length === 0){
                    tbody.append('<tr><td colspan="8" class="text-center">Sin resultados</td></tr>');
                } else {
                    resp.forEach(o => {
                        const invoiceUsage = renderUsage(o.usage.invoice);
                        const customerUsage = renderUsage(o.usage.customer);
                        const productUsage = renderUsage(o.usage.product);
                        const companyName = o.company.name || '<span class="badge badge-warning">Sin compañía</span>';
                        const companyInfo = o.company.id ? `${companyName}<br><small class="text-muted">RUC: ${o.company.ruc}</small>` : companyName;
                        tbody.append(`
                        <tr>
                            <td>
                                ${o.owner.name}<br>
                                <small class="text-muted">@${o.owner.username}</small><br>
                                <small class="badge badge-primary">${o.owner.groups}</small>
                            </td>
                            <td>${companyInfo}</td>
                            <td>${o.plan.name}</td>
                            <td>${invoiceUsage}</td>
                            <td>${customerUsage}</td>
                            <td>${productUsage}</td>
                            <td>${o.start_date}</td>
                            <td>${o.end_date || ''}</td>
                            <td>${o.is_active ? '<span class="badge badge-success">Sí</span>' : '<span class="badge badge-danger">No</span>'}</td>
                            <td>${o.expired ? '<span class="badge badge-danger">Sí</span>' : '<span class="badge badge-success">No</span>'}</td>
                            <td>${o.days_left ?? ''}</td>
                            <td class="text-center">
                                <a href="/subscription/update/${o.id}/" class="btn btn-warning btn-xs"><i class="fas fa-edit"></i></a>
                                <button class="btn btn-danger btn-xs btn-delete" data-id="${o.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`);
                    });
                }
            }
        });
    }
    $(function(){
        loadSubs();
        $('table').on('click', '.btn-delete', function(){
            if(!confirm('¿Eliminar suscripción?')) return;
            const id = $(this).data('id');
            $.ajax({
                url: window.location.pathname,
                method: 'POST',
                data: {action: 'delete', id: id, csrfmiddlewaretoken: '{{ csrf_token }}'},
                success: function(resp){
                    if(resp.error){
                        alert(resp.error);
                    } else {
                        loadSubs();
                    }
                }
            });
        });
    });
</script>
{% endblock %}
