{% extends 'list.html' %}
{% load static %}

{% block columns %}
<tr>
    <th>Nombre</th>
    <th>Descripción</th>
    <th>Facturas</th>
    <th>Clientes</th>
    <th>Productos</th>
    <th>Precio</th>
    <th>Días</th>
    <th>Activo</th>
    <th class="text-center">Opciones</th>
</tr>
{% endblock %}

{% block rows %}{% endblock %}

{% block javascript_list %}
<script>
    function loadPlans(){
        $.ajax({
            url: window.location.pathname,
            method: 'POST',
            dataType: 'json',
            data: {action: 'search', csrfmiddlewaretoken: '{{ csrf_token }}'},
            success: function(resp){
                var tbody = $('table tbody');
                tbody.empty();
                if(resp.length === 0){
                    tbody.append('<tr><td colspan="9" class="text-center">Sin resultados</td></tr>');
                } else {
                    resp.forEach(function(o){
                        tbody.append(
                        '<tr>'+
                            '<td>'+o.name+'</td>'+
                            '<td>'+(o.description || '-')+'</td>'+
                            '<td>'+(o.max_invoices || '∞')+'</td>'+
                            '<td>'+(o.max_customers || '∞')+'</td>'+
                            '<td>'+(o.max_products || '∞')+'</td>'+
                            '<td>$'+o.price+'</td>'+
                            '<td>'+o.period_days+'</td>'+
                            '<td>'+(o.active ? '<span class="badge badge-success">Sí</span>' : '<span class="badge badge-danger">No</span>')+'</td>'+
                            '<td class="text-center">'+
                                '<a href="/subscription/plan/update/'+o.id+'/" class="btn btn-warning btn-xs"><i class="fas fa-edit"></i></a> '+
                                '<button class="btn btn-danger btn-xs btn-delete" data-id="'+o.id+'"><i class="fas fa-trash"></i></button>'+
                            '</td>'+
                        '</tr>');
                    });
                }
            },
            error: function(){
                alert('Error cargando planes');
            }
        });
    }

    $(function(){
        loadPlans();

        $('table').on('click','.btn-delete', function(){
            if(!confirm('¿Eliminar plan?')) return;
            var id = $(this).data('id');
            $.ajax({
                url: window.location.pathname,
                method: 'POST',
                dataType: 'json',
                data: {action: 'delete', id: id, csrfmiddlewaretoken: '{{ csrf_token }}'},
                success: function(resp){
                    if(resp.error){
                        alert(resp.error);
                    } else {
                        loadPlans();
                    }
                },
                error: function(){
                    alert('Error eliminando plan');
                }
            });
        });
    });
</script>
{% endblock %}
