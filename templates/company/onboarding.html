{% extends 'base.html' %}
{% load static %}
{% block body %}
<div class="onboarding-container">
  <div class="onboarding-header">
    <h1>Configuración Inicial</h1>
    <p>Configura tu empresa en 5 pasos simples. La información se puede editar más tarde.</p>
  </div>

  <!-- Progress Steps -->
  <div class="progress-steps">
    <div class="step active" data-step="1">
      <div class="step-icon">1</div>
      <span>Información Básica</span>
    </div>
    <div class="step" data-step="2">
      <div class="step-icon">2</div>
      <span>Ubicación</span>
    </div>
    <div class="step" data-step="3">
      <div class="step-icon">3</div>
      <span>Tributario</span>
    </div>
    <div class="step" data-step="4">
      <div class="step-icon">4</div>
      <span>Contacto</span>
    </div>
    <div class="step" data-step="5">
      <div class="step-icon">5</div>
      <span>Firma Digital</span>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="onboarding-form">
    {% csrf_token %}

    <!-- Campos ocultos con valores por defecto -->
    {{ form.establishment_address.as_hidden }}
    {{ form.special_taxpayer.as_hidden }}
    {{ form.tax.as_hidden }}
    {{ form.environment_type.as_hidden }}
    {{ form.emission_type.as_hidden }}

    <!-- Step 1: Información Básica -->
    <div class="form-step active" data-step="1">
      <h2><i class="fas fa-building"></i> Información Básica</h2>
      <div class="fields-grid">
        <div class="field-group">
          <label for="id_ruc">{{ form.ruc.label }} <span class="required">*</span></label>
          {{ form.ruc }}
          {% if form.ruc.help_text %}<small>{{ form.ruc.help_text }}</small>{% endif %}
          {% for error in form.ruc.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_company_name">{{ form.company_name.label }} <span class="required">*</span></label>
          {{ form.company_name }}
          {% if form.company_name.help_text %}<small>{{ form.company_name.help_text }}</small>{% endif %}
          {% for error in form.company_name.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_commercial_name">{{ form.commercial_name.label }} <span class="required">*</span></label>
          {{ form.commercial_name }}
          {% if form.commercial_name.help_text %}<small>{{ form.commercial_name.help_text }}</small>{% endif %}
          {% for error in form.commercial_name.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_image">{{ form.image.label }}</label>
          {{ form.image }}
          <small>Sube el logo de tu empresa (opcional)</small>
          {% for error in form.image.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
      </div>
    </div>

    <!-- Step 2: Ubicación -->
    <div class="form-step" data-step="2">
      <h2><i class="fas fa-map-marker-alt"></i> Ubicación y Códigos</h2>
      <div class="fields-grid">
        <div class="field-group full-width">
          <label for="id_main_address">{{ form.main_address.label }} <span class="required">*</span></label>
          {{ form.main_address }}
          {% if form.main_address.help_text %}<small>{{ form.main_address.help_text }}</small>{% endif %}
          {% for error in form.main_address.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_establishment_code">{{ form.establishment_code.label }} <span class="required">*</span></label>
          {{ form.establishment_code }}
          <small>Código de establecimiento (por defecto: 001)</small>
          {% for error in form.establishment_code.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_issuing_point_code">{{ form.issuing_point_code.label }} <span class="required">*</span></label>
          {{ form.issuing_point_code }}
          <small>Código de punto de emisión (por defecto: 001)</small>
          {% for error in form.issuing_point_code.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
      </div>
    </div>

    <!-- Step 3: Información Tributaria -->
    <div class="form-step" data-step="3">
      <h2><i class="fas fa-calculator"></i> Configuración Tributaria</h2>
      <div class="fields-grid">
        <div class="field-group">
          <label for="id_obligated_accounting">{{ form.obligated_accounting.label }}</label>
          {{ form.obligated_accounting }}
          {% for error in form.obligated_accounting.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_retention_agent">{{ form.retention_agent.label }}</label>
          {{ form.retention_agent }}
          {% for error in form.retention_agent.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_regimen_rimpe">{{ form.regimen_rimpe.label }}</label>
          {{ form.regimen_rimpe }}
          {% for error in form.regimen_rimpe.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_tax_percentage">{{ form.tax_percentage.label }}</label>
          {{ form.tax_percentage }}
          <small>Porcentaje de IVA a aplicar</small>
          {% for error in form.tax_percentage.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="is_special_taxpayer">¿Es contribuyente especial?</label>
          <select id="is_special_taxpayer" class="form-control">
            <option value="no">No</option>
            <option value="yes">Sí</option>
          </select>
          <small>Seleccione si la empresa es contribuyente especial</small>
        </div>
        <div class="field-group" id="special_taxpayer_number_group" style="display: none;">
          <label for="special_taxpayer_number">Número de Resolución</label>
          <input type="text" id="special_taxpayer_number" class="form-control" placeholder="Ej: 1234567890123">
          <small>Ingrese el número de resolución del contribuyente especial</small>
        </div>
      </div>
    </div>

    <!-- Step 4: Información de Contacto -->
    <div class="form-step" data-step="4">
      <h2><i class="fas fa-phone"></i> Información de Contacto</h2>
      <div class="fields-grid">
        <div class="field-group">
          <label for="id_mobile">{{ form.mobile.label }}</label>
          {{ form.mobile }}
          {% for error in form.mobile.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_phone">{{ form.phone.label }}</label>
          {{ form.phone }}
          {% for error in form.phone.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_email">{{ form.email.label }} <span class="required">*</span></label>
          {{ form.email }}
          {% for error in form.email.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_website">{{ form.website.label }}</label>
          {{ form.website }}
          {% for error in form.website.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group full-width">
          <label for="id_description">{{ form.description.label }}</label>
          {{ form.description }}
          <small>Describe brevemente tu empresa (opcional)</small>
          {% for error in form.description.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
      </div>
    </div>

    <!-- Step 5: Firma Electrónica -->
    <div class="form-step" data-step="5">
      <h2><i class="fas fa-certificate"></i> Firma Electrónica</h2>
      <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <p>La firma electrónica es necesaria para la facturación electrónica. Si no la tienes ahora, puedes configurarla
          más tarde.</p>
      </div>
      <div class="fields-grid">
        <div class="field-group">
          <label for="id_electronic_signature">{{ form.electronic_signature.label }}</label>
          {{ form.electronic_signature }}
          <small>Archivo .p12 de tu firma electrónica</small>
          {% for error in form.electronic_signature.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>
        <div class="field-group">
          <label for="id_electronic_signature_key">{{ form.electronic_signature_key.label }}</label>
          {{ form.electronic_signature_key }}
          <small>Clave de tu firma electrónica</small>
          {% for error in form.electronic_signature_key.errors %}<div class="error">{{ error }}</div>{% endfor %}
        </div>

      </div>
    </div>

    {% if form.non_field_errors %}
    <div class="error-box">
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <strong>Errores en el formulario:</strong>
        {% for error in form.non_field_errors %}
        <div>{{ error }}</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Navigation Buttons -->
    <div class="form-navigation">
      <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
        <i class="fas fa-arrow-left"></i> Anterior
      </button>
      <button type="button" class="btn btn-primary" id="nextBtn">
        Siguiente <i class="fas fa-arrow-right"></i>
      </button>
      <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
        <i class="fas fa-check"></i> Completar Configuración
      </button>
    </div>
  </form>
</div>

<style>
  .onboarding-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 0 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .onboarding-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .onboarding-header h1 {
    color: #2c3e50;
    font-size: 32px;
    font-weight: 700;
    margin: 0 0 10px 0;
  }

  .onboarding-header p {
    color: #7f8c8d;
    font-size: 16px;
    margin: 0;
  }

  .progress-steps {
    display: flex;
    justify-content: center;
    margin-bottom: 40px;
    position: relative;
  }

  .progress-steps::before {
    content: '';
    position: absolute;
    top: 25px;
    left: 0;
    right: 0;
    height: 2px;
    background: #ecf0f1;
    z-index: 1;
  }

  .step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    max-width: 150px;
    position: relative;
    z-index: 2;
  }

  .step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #ecf0f1;
    color: #95a5a6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .step.active .step-icon,
  .step.completed .step-icon {
    background: #3498db;
    color: white;
  }

  .step.completed .step-icon {
    background: #27ae60;
  }

  .step span {
    font-size: 12px;
    color: #7f8c8d;
    text-align: center;
    font-weight: 500;
  }

  .step.active span {
    color: #3498db;
    font-weight: 600;
  }

  .onboarding-form {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 40px;
    margin-bottom: 20px;
  }

  .form-step {
    display: none;
    animation: fadeInSlide 0.3s ease-in-out;
  }

  .form-step.active {
    display: block;
  }

  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateX(20px);
    }

    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes pulse {

    0%,
    100% {
      transform: scale(1);
      box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
    }

    50% {
      transform: scale(1.02);
      box-shadow: 0 6px 25px rgba(220, 53, 69, 0.5);
    }
  }

  /* Estilos para campos con errores */
  .field-group.has-error {
    position: relative;
    animation: errorShake 0.5s ease-in-out;
  }

  .field-group.has-error input,
  .field-group.has-error select {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    background-color: rgba(220, 53, 69, 0.05) !important;
  }

  .field-group.has-error label {
    color: #dc3545 !important;
    font-weight: 600;
  }

  .field-group.has-error::after {
    content: "Este campo es obligatorio";
    position: absolute;
    bottom: -20px;
    left: 0;
    color: #dc3545;
    font-size: 12px;
    font-weight: 500;
    opacity: 0.9;
  }

  @keyframes errorShake {

    0%,
    20%,
    50%,
    80%,
    100% {
      transform: translateX(0);
    }

    10%,
    30%,
    70%,
    90% {
      transform: translateX(-5px);
    }

    40%,
    60% {
      transform: translateX(5px);
    }
  }

  .form-step h2 {
    color: #2c3e50;
    font-size: 24px;
    font-weight: 600;
    margin: 0 0 30px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-step h2 i {
    color: #3498db;
  }

  .fields-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    align-items: start;
  }

  .field-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 25px;
    position: relative;
  }

  .field-group.full-width {
    grid-column: 1 / -1;
  }

  .field-group label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 14px;
  }

  .required {
    color: #e74c3c;
  }

  .field-group input,
  .field-group select,
  .field-group textarea {
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: #fafbfc;
    width: 100%;
    box-sizing: border-box;
    min-height: 44px;
  }

  .field-group input:focus,
  .field-group select:focus,
  .field-group textarea:focus {
    outline: none;
    border-color: #3498db;
    background: white;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
  }

  .field-group small {
    color: #7f8c8d;
    font-size: 12px;
    margin-top: 5px;
  }

  .error {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
    font-weight: 500;
    padding: 8px 12px;
    background: #ffe6e6;
    border-radius: 4px;
    border-left: 4px solid #e74c3c;
    display: block;
  }

  .field-group.has-error input,
  .field-group.has-error select,
  .field-group.has-error textarea {
    border-color: #e74c3c !important;
    background-color: #fff5f5;
  }

  .field-group.has-error label {
    color: #e74c3c;
  }

  .info-box {
    background: #e8f4f8;
    border: 1px solid #bee5eb;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 25px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .info-box i {
    color: #17a2b8;
    margin-top: 2px;
  }

  .info-box p {
    margin: 0;
    color: #0c5460;
    font-size: 14px;
    line-height: 1.5;
  }

  .error-box {
    background: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    border: 1px solid #f5c6cb;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .error-box i {
    color: #dc3545;
    margin-top: 2px;
  }

  .error-box strong {
    display: block;
    margin-bottom: 5px;
  }

  .form-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #ecf0f1;
  }

  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-primary:hover {
    background: #2980b9;
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-secondary:hover {
    background: #7f8c8d;
  }

  .btn-success {
    background: #27ae60;
    color: white;
  }

  .btn-success:hover {
    background: #229954;
    transform: translateY(-1px);
  }

  @media (max-width: 768px) {
    .onboarding-container {
      padding: 0 15px;
    }

    .onboarding-form {
      padding: 20px;
    }

    .fields-grid {
      grid-template-columns: 1fr;
    }

    .progress-steps {
      flex-wrap: wrap;
      gap: 10px;
    }

    .step {
      min-width: 80px;
    }

    .step-icon {
      width: 40px;
      height: 40px;
    }
  }
</style>

<script>



  let currentStep = 1;
  const totalSteps = 5;

  function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));

    // Show current step
    document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');

    // Update progress
    for (let i = 1; i <= totalSteps; i++) {
      const stepEl = document.querySelector(`.step[data-step="${i}"]`);
      if (i < step) {
        stepEl.classList.add('completed');
      } else if (i === step) {
        stepEl.classList.add('active');
      }
    }

    // Update navigation buttons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');

    prevBtn.style.display = step > 1 ? 'flex' : 'none';
    nextBtn.style.display = step < totalSteps ? 'flex' : 'none';
    submitBtn.style.display = step === totalSteps ? 'flex' : 'none';
  }

  function validateStep(step) {
    const stepEl = document.querySelector(`.form-step[data-step="${step}"]`);
    const requiredFields = stepEl.querySelectorAll('input[required], select[required]');
    let isValid = true;
    let firstInvalidField = null;

    // Limpiar errores previos del paso actual
    stepEl.querySelectorAll('.field-group').forEach(group => {
      group.classList.remove('has-error');
    });

    // Validar cada campo requerido
    for (let field of requiredFields) {
      if (!field.value.trim()) {
        const fieldGroup = field.closest('.field-group');
        if (fieldGroup) {
          fieldGroup.classList.add('has-error');
          if (!firstInvalidField) {
            firstInvalidField = field;
          }
        }
        isValid = false;
      }
    }

    // Validación especial para contribuyente especial en el paso 3
    if (step === 3) {
      const isSpecialTaxpayer = document.getElementById('is_special_taxpayer');
      const specialTaxpayerNumber = document.getElementById('special_taxpayer_number');
      
      if (isSpecialTaxpayer && isSpecialTaxpayer.value === 'yes') {
        if (!specialTaxpayerNumber || !specialTaxpayerNumber.value.trim()) {
          const fieldGroup = specialTaxpayerNumber.closest('.field-group');
          if (fieldGroup) {
            fieldGroup.classList.add('has-error');
            if (!firstInvalidField) {
              firstInvalidField = specialTaxpayerNumber;
            }
          }
          isValid = false;
        }
      }
    }

    // Si hay errores, enfocar el primer campo inválido
    if (!isValid && firstInvalidField) {
      firstInvalidField.focus();
      firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    return isValid;
  }

  document.getElementById('nextBtn').addEventListener('click', () => {
    if (validateStep(currentStep)) {
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      }
    }
  });

  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  });

  // Initialize
  showStep(currentStep);

  // Add required attributes to essential fields
  document.addEventListener('DOMContentLoaded', function () {
    const requiredFields = [
      'id_ruc', 'id_company_name', 'id_commercial_name', 'id_main_address',
      'id_establishment_code', 'id_issuing_point_code', 'id_email'
    ];

    requiredFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.setAttribute('required', 'required');
      }
    });

    // Agregar validación en tiempo real
    const allFields = document.querySelectorAll('input, select');
    allFields.forEach(field => {
      field.addEventListener('input', function () {
        const fieldGroup = this.closest('.field-group');
        if (fieldGroup && fieldGroup.classList.contains('has-error')) {
          if (this.value.trim()) {
            fieldGroup.classList.remove('has-error');
          }
        }
      });

      field.addEventListener('blur', function () {
        if (this.hasAttribute('required') && !this.value.trim()) {
          const fieldGroup = this.closest('.field-group');
          if (fieldGroup) {
            fieldGroup.classList.add('has-error');
          }
        }
      });
    });

    // Manejar lógica del contribuyente especial
    const isSpecialTaxpayerSelect = document.getElementById('is_special_taxpayer');
    const specialTaxpayerNumberGroup = document.getElementById('special_taxpayer_number_group');
    const specialTaxpayerNumberInput = document.getElementById('special_taxpayer_number');
    const hiddenSpecialTaxpayerField = document.getElementById('id_special_taxpayer');

    if (isSpecialTaxpayerSelect && specialTaxpayerNumberGroup && specialTaxpayerNumberInput && hiddenSpecialTaxpayerField) {
      // Mostrar/ocultar campo de número de resolución
      isSpecialTaxpayerSelect.addEventListener('change', function() {
        if (this.value === 'yes') {
          specialTaxpayerNumberGroup.style.display = 'flex';
          specialTaxpayerNumberInput.setAttribute('required', 'required');
          // Si no hay valor, dejar vacío para que el usuario lo llene
          if (!specialTaxpayerNumberInput.value) {
            hiddenSpecialTaxpayerField.value = '';
          }
        } else {
          // No es contribuyente especial: usar 000
          specialTaxpayerNumberGroup.style.display = 'none';
          specialTaxpayerNumberInput.removeAttribute('required');
          specialTaxpayerNumberInput.value = '000';
          hiddenSpecialTaxpayerField.value = '000';
        }
      });

      // Copiar valor al campo oculto cuando se escriba
      specialTaxpayerNumberInput.addEventListener('input', function() {
        hiddenSpecialTaxpayerField.value = this.value;
      });

      // Inicializar el campo oculto basado en el valor actual
      if (hiddenSpecialTaxpayerField.value && hiddenSpecialTaxpayerField.value.trim() !== '') {
        if (hiddenSpecialTaxpayerField.value === '000') {
          // No es contribuyente especial
          isSpecialTaxpayerSelect.value = 'no';
          specialTaxpayerNumberGroup.style.display = 'none';
          specialTaxpayerNumberInput.value = '000';
        } else {
          // Es contribuyente especial con número real
          isSpecialTaxpayerSelect.value = 'yes';
          specialTaxpayerNumberGroup.style.display = 'flex';
          specialTaxpayerNumberInput.value = hiddenSpecialTaxpayerField.value;
          specialTaxpayerNumberInput.setAttribute('required', 'required');
        }
      } else {
        // Valor por defecto: no es contribuyente especial
        isSpecialTaxpayerSelect.value = 'no';
        specialTaxpayerNumberInput.value = '000';
        hiddenSpecialTaxpayerField.value = '000';
      }
    }

    // Procesar errores de campos individuales
    const fieldGroups = document.querySelectorAll('.field-group');
    fieldGroups.forEach(group => {
      const errorDiv = group.querySelector('.error');
      if (errorDiv) {
        group.classList.add('has-error');
      }
    });

    // Mostrar errores de validación si existen
    const errorBox = document.querySelector('.error-box');
    if (errorBox) {
      errorBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Destacar el error por un momento
      setTimeout(() => {
        errorBox.style.animation = 'pulse 0.5s ease-in-out 3';
      }, 500);
    }

    // Si hay errores de campo, hacer scroll al primer campo con error
    const firstErrorField = document.querySelector('.field-group.has-error');
    if (firstErrorField && !errorBox) {
      firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });

      // Determinar en qué paso está el error
      let errorStep = 1;
      const formSteps = document.querySelectorAll('.form-step');
      formSteps.forEach((step, index) => {
        if (step.contains(firstErrorField)) {
          errorStep = index + 1;
        }
      });

      // Cambiar al paso con error
      if (errorStep !== currentStep) {
        currentStep = errorStep;
        showStep(currentStep);
      }
    }

    // Actualizar campos ocultos antes del envío
    const form = document.querySelector('.onboarding-form');
    form.addEventListener('submit', function (e) {
      console.log('Form submission started');

      // Actualizar establishment_address con main_address si está vacío
      const mainAddress = document.getElementById('id_main_address');
      const establishmentAddress = document.getElementById('id_establishment_address');
      if (mainAddress && establishmentAddress) {
        establishmentAddress.value = mainAddress.value;
      }

      // Sincronizar tax con tax_percentage
      const taxPercentage = document.getElementById('id_tax_percentage');
      const tax = document.getElementById('id_tax');
      if (taxPercentage && tax) {
        // Valor inicial
        tax.value = taxPercentage.value || '15';
        
        // Sincronizar cuando cambie tax_percentage
        taxPercentage.addEventListener('input', function() {
          tax.value = this.value || '15';
        });
        
        taxPercentage.addEventListener('change', function() {
          tax.value = this.value || '15';
        });
      }

      // Log form data for debugging
      const formData = new FormData(form);
      console.log('Form data:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }
    });
  });
</script>
{% endblock %}